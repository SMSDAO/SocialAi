---
import Layout from '../layouts/Layout.astro';

const title = 'Timeline - SocialAi';
const description = 'Discover the latest posts and activity from across the SocialAi network.';

const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:3000';
let posts: any[] = [];
let error = null;

try {
  const response = await fetch(`${API_URL}/api/timeline?limit=50`);
  if (response.ok) {
    posts = await response.json();
  } else {
    error = 'Failed to load timeline';
  }
} catch (err) {
  console.error('Failed to fetch timeline:', err);
  error = 'Failed to connect to API';
}
---

<Layout title={title}>
  <meta slot="head" name="description" content={description} />
  <meta slot="head" property="og:title" content={title} />
  <meta slot="head" property="og:description" content={description} />

  <style>
    .page-header {
      text-align: center;
      margin-bottom: 3rem;
    }
    .page-header h1 {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 0.75rem;
      color: #333;
    }
    .page-header p {
      font-size: 1.125rem;
      color: #666;
    }
    .timeline-container {
      max-width: 700px;
      margin: 0 auto;
    }
    .filter-tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      background: white;
      padding: 1rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .filter-tab {
      flex: 1;
      padding: 0.75rem 1.5rem;
      border: none;
      background: transparent;
      border-radius: 8px;
      font-weight: 600;
      color: #666;
      cursor: pointer;
      transition: all 0.2s;
    }
    .filter-tab:hover {
      background: #f5f5f5;
    }
    .filter-tab.active {
      background: #667eea;
      color: white;
    }
    .timeline {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .post-card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: box-shadow 0.2s;
    }
    .post-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }
    .post-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .post-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: white;
      text-decoration: none;
    }
    .post-author {
      flex: 1;
    }
    .post-author-link {
      text-decoration: none;
      color: inherit;
    }
    .post-author-name {
      font-weight: 700;
      color: #333;
      margin-bottom: 0.125rem;
    }
    .post-author-link:hover .post-author-name {
      color: #667eea;
    }
    .post-username {
      font-size: 0.875rem;
      color: #999;
    }
    .post-timestamp {
      font-size: 0.875rem;
      color: #999;
      text-align: right;
    }
    .post-content {
      color: #333;
      line-height: 1.7;
      margin-bottom: 1rem;
    }
    .post-source {
      display: inline-block;
      background: #f0f0f0;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      color: #666;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    .post-actions {
      display: flex;
      gap: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid #f0f0f0;
    }
    .post-action {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #999;
      font-size: 0.875rem;
      font-weight: 600;
    }
    .error-message {
      background: #fee;
      color: #c33;
      padding: 1.5rem;
      border-radius: 12px;
      text-align: center;
    }
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }
    .empty-state h2 {
      font-size: 1.5rem;
      color: #666;
      margin-bottom: 0.5rem;
    }
    .load-more {
      text-align: center;
      margin-top: 2rem;
    }
    .btn-load-more {
      padding: 0.875rem 2rem;
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-load-more:hover {
      background: #667eea;
      color: white;
    }
  </style>

  <div class="page-header">
    <h1>üåä Timeline</h1>
    <p>Latest activity from across the network</p>
  </div>

  <div class="timeline-container">
    <div class="filter-tabs">
      <button class="filter-tab active" data-filter="all">All Posts</button>
      <button class="filter-tab" data-filter="farcaster">Farcaster</button>
      <button class="filter-tab" data-filter="reddit">Reddit</button>
    </div>

    {error ? (
      <div class="error-message">
        {error}
      </div>
    ) : posts.length === 0 ? (
      <div class="empty-state">
        <div class="empty-state-icon">üì≠</div>
        <h2>No posts yet</h2>
        <p>Check back soon for new content!</p>
      </div>
    ) : (
      <div class="timeline">
        {posts.map((post: any) => (
          <article class="post-card" data-source={post.source || 'internal'}>
            <div class="post-header">
              <a href={`/profile/${post.author?.username || 'unknown'}`} class="post-avatar">
                {post.author?.avatar ? (
                  <img 
                    src={post.author.avatar} 
                    alt={post.author.displayName} 
                    style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" 
                  />
                ) : (
                  post.author?.displayName?.[0]?.toUpperCase() || 
                  post.author?.username?.[0]?.toUpperCase() || 
                  '?'
                )}
              </a>
              <div class="post-author">
                <a href={`/profile/${post.author?.username || 'unknown'}`} class="post-author-link">
                  <div class="post-author-name">
                    {post.author?.displayName || post.author?.username || 'Unknown'}
                  </div>
                  <div class="post-username">
                    @{post.author?.username || 'unknown'}
                  </div>
                </a>
              </div>
              <div class="post-timestamp">
                {new Date(post.createdAt).toLocaleDateString('en-US', { 
                  month: 'short', 
                  day: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit'
                })}
              </div>
            </div>

            {post.source && (
              <span class="post-source">
                {post.source === 'farcaster' && 'üü£ Farcaster'}
                {post.source === 'reddit' && 'üî∂ Reddit'}
                {post.source === 'internal' && 'üåê SocialAi'}
              </span>
            )}

            <div class="post-content">{post.content}</div>

            {(post.likesCount > 0 || post.repliesCount > 0 || post.repostsCount > 0) && (
              <div class="post-actions">
                {post.likesCount > 0 && (
                  <span class="post-action">‚ù§Ô∏è {post.likesCount}</span>
                )}
                {post.repliesCount > 0 && (
                  <span class="post-action">üí¨ {post.repliesCount}</span>
                )}
                {post.repostsCount > 0 && (
                  <span class="post-action">üîÑ {post.repostsCount}</span>
                )}
              </div>
            )}
          </article>
        ))}
      </div>
    )}

    {!error && posts.length > 0 && (
      <div class="load-more">
        <button class="btn-load-more">Load More</button>
      </div>
    )}
  </div>

  <script>
    // Filter functionality
    const filterTabs = document.querySelectorAll('.filter-tab');
    const postCards = document.querySelectorAll('.post-card');
    
    filterTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const filter = tab.getAttribute('data-filter');
        
        // Update active tab
        filterTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // Filter posts
        postCards.forEach(card => {
          const source = card.getAttribute('data-source');
          if (filter === 'all') {
            (card as HTMLElement).style.display = 'block';
          } else {
            (card as HTMLElement).style.display = source === filter ? 'block' : 'none';
          }
        });
      });
    });
  </script>
</Layout>
